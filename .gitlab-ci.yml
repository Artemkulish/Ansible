image: gitlab.svagworks.me:5050/root/demo_2

variables:
    PATH_TO_JAR:    /target/*.jar
    IP_BILLING:     10.128.0.x
    IP_CUSTOMERS:   10.128.0.x
    IP_GATEWAY:     10.128.0.x
    IP_GOOGLE_MAPS: 10.128.0.x
    IP_DISCOVERY:   10.128.0.x

before_script:
    - 'which ssh-agent || ( apt update -y && apt install openssh-client -y)'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

stages:
    - build
    - deploy

.build_template: &build_template
    stage: build
    script:
        - cd $PATH_TO_APP
        - mvn clean package
    artifacts:
        paths:
        - $PATH_TO_APP$PATH_TO_JAR
        expire_in: 1 week
    #only:
        #variables:
            #- $CI_COMMIT_MESSAGE =~ /$CI_JOB_NAME/

build_billing:
    <<: *build_template
    variables:
        PATH_TO_APP: BE/BillingService
    only:
        variables:
            - $CI_COMMIT_MESSAGE =~ /billing/
        
build_customers:
    <<: *build_template
    variables:
        PATH_TO_APP: BE/CustomerService/customers
    only:
        variables:
            - $CI_COMMIT_MESSAGE =~ /customers/
        
build_gateway:
    <<: *build_template
    variables:
        PATH_TO_APP: BE/Gateway
    only:
        variables:
            - $CI_COMMIT_MESSAGE =~ /gateway/
        
build_google_maps:
    <<: *build_template
    variables:
        PATH_TO_APP: BE/GoogleMapsMicroservice
    only:
        variables:
            - $CI_COMMIT_MESSAGE =~ /maps/
        
build_discovery:
    <<: *build_template
    variables:
        PATH_TO_APP: BE/ServiceDiscovery
    only:
        variables:
            - $CI_COMMIT_MESSAGE =~ /discovery/
        
#build_order:
#    <<: *build_template
#    variables:
#        PATH_TO_APP: BE/OrderService
#        SERVICE_NAME: order

#build_provider:
#    <<: *build_template
#    variables:
#        PATH_TO_APP: BE/ServiceProvider
#        SERVICE_NAME: provider
         
deploy:
    stage: deploy
    script:
      - echo "OK"
      #- scp BE/BillingService/target/*.jar $UN_IP:/tmp
      #- scp BE/CustomerService/customers/target/*.jar $UN_IP:/tmp
      #- scp BE/Gateway/target/*.jar $UN_IP:/tmp
      #- scp deploy.sh $UN_IP:/tmp
      #- scp BE/GoogleMapsMicroservice/target/*.jar $UN_IP:/tmp
      #- scp BE/OrderService/target/*.jar $UN_IP:/tmp
      #- scp BE/ServiceDiscovery/target/*.jar $UN_IP:/tmp
      #- scp BE/ServiceProvider/target/*.jar $UN_IP:/tmp
      #- ssh $UN_IP "cd /tmp && sudo bash deploy.sh "

