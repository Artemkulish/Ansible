---
- name: Create VM
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars_files:
  - var
  tasks:
   - name: Launch instances
     gce:
      instance_names: app-instance-1       
      machine_type: "{{ machine_type }}"
      image: "{{ image }}"
      service_account_email: "{{ service_account_email }}"
      credentials_file: "{{ credentials_file }}"
      project_id: "{{ project_id }}"
      zone: "{{ zone }}"
#      external_ip: none
      tags: 
      - webserver
      - http-server
      - https-server
     register: gce
   - debug:
        var: gce
   - name: Save hosts data
     add_host:
      hostname: "{{ item.public_ip }}"
      groupname: gce_instaces_java
     with_items: "{{ gce.instance_data }}"
   - debug:
       var: hostname
   - name: Wait for SSH for instances
     wait_for:
      delay: 10
      host: "{{ item.public_ip }}"
      port: 22
      state: started
      timeout: 60
     with_items: "{{ gce.instance_data }}"

- name: Configure Hosts
  hosts: gce_instaces_java
#  become: yes
#  become_method: sudo
  gather_facts: no
  roles:
  - docker-compose
